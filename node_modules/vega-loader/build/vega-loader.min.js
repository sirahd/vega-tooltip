!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("vega-util"),require("d3-request"),require("d3-dsv"),require("topojson"),require("d3-time-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-request","d3-dsv","topojson","d3-time-format"],r):r(e.vega=e.vega||{},e.vega,e.d3,e.d3,e.topojson,e.d3)}(this,function(e,r,t,n,o,i){"use strict";function u(e,t){return r.extend({},e.options,t)}function f(e,r){var t=this;return t.sanitize(e,r).then(function(e){var n=e.href;return d(n,w)?t.file(n.slice(w.length)):t.http(n,r)})}function s(e,t){return t=u(this,t),new Promise(function(n,o){var i,u,f,s;return null==e||"string"!=typeof e?void o("Sanitize failure, invalid URI: "+r.stringValue(e)):(u=P.test(e),(s=t.baseURL)&&!u&&(d(e,"/")||"/"===s[s.length-1]||(e="/"+e),e=s+e),f=(i=d(e,w))||"file"===t.mode||"http"!==t.mode&&!u&&l(),f?e=(i?"":w)+e:d(e,"//")&&(e=(t.defaultProtocol||"http")+":"+e),void n({href:e}))})}function a(e,r){return r=u(this,r),new Promise(function(n,o){var i,u=t.request(e);for(i in r.headers)u.header(i,r.headers[i]);S.forEach(function(e){r[e]&&u[e](r[e])}),u.on("error",function(r){o(r||"Error loading URL: "+e)}).on("load",function(e){var r=e&&e.responseText;e&&0!==e.status?n(r):o(r||"Error")}).get()})}function c(e){return new Promise(function(r,t){var n=l();n?n.readFile(e,function(e,n){e?t(e):r(n)}):t("No file system access for "+e)})}function l(){var e="function"==typeof require&&require("fs");return e&&r.isFunction(e.readFile)?e:null}function d(e,r){return null!=e&&0===e.lastIndexOf(r,0)}function p(e,r){var t,n,o,i,u=J.slice();for(n=0,o=e.length;n<o;++n){for(t=r?e[n][r]:e[n],i=0;i<u.length;++i)h(t)&&!u[i](t)&&(u.splice(i,1),--i);if(0===u.length)return"string"}return F[J.indexOf(u[0])]}function m(e,r){return r.reduce(function(r,t){return r[t]=p(e,t),r},{})}function h(e){return null!=e&&e===e}function v(e){return"true"===e||"false"===e||e===!0||e===!1}function g(e){return!isNaN(Date.parse(e))}function y(e){return!(isNaN(+e)||e instanceof Date)}function b(e){return y(e)&&(e=+e)===~~e}function j(e){return function(t,n){var o={delimiter:e};return O(t,n?r.extend(n,o):o)}}function O(e,t){return t.header&&(e=t.header.map(r.stringValue).join(t.delimiter)+"\n"+e),n.dsvFormat(t.delimiter).parse(e+"")}function N(e){return!("function"!=typeof Buffer||!r.isFunction(Buffer.isBuffer))&&Buffer.isBuffer(e)}function q(e,r){return r&&r.copy?JSON.parse(JSON.stringify(e)):e}function x(e,r,t){t=t||i.timeParse;var n,o,u,f,s,a,c,l=e.columns||Object.keys(e[0]);for("auto"===r&&(r=m(e,l)),l=Object.keys(r),n=l.map(function(e){var n,o,u=r[e];if(u&&(0===u.indexOf("date:")||0===u.indexOf("utc:")))return n=u.split(/:(.+)?/,2),o=n[1],("'"===o[0]&&"'"===o[o.length-1]||'"'===o[0]&&'"'===o[o.length-1])&&(o=o.slice(1,-1)),"utc"===n[0]?i.utcParse(o):t(o);if(!B[u])throw Error("Illegal format pattern: "+e+":"+u);return B[u]}),f=0,a=e.length,c=l.length;f<a;++f)for(o=e[f],s=0;s<c;++s)u=l[s],o[u]=n[s](o[u])}var P=/^([A-Za-z]+:)?\/\//,w="file://",S=["mimeType","responseType","user","password"],T=function(e){return{options:e||{},sanitize:s,load:f,file:c,http:a}},B={boolean:r.toBoolean,integer:r.toNumber,number:r.toNumber,date:r.toDate,string:r.toString},J=[v,b,y,g],F=["boolean","integer","number","date"],I=function(e,t){var n=t&&t.property?r.field(t.property):r.identity;return r.isObject(e)&&!N(e)?q(n(e)):n(JSON.parse(e))},z=function(e,t){var n,i;return e=I(e,t),t&&(i=t.feature)?(n=e.objects[i])?o.feature(e,n).features:r.error("Invalid TopoJSON object: "+i):t&&(i=t.mesh)?(n=e.objects[i])?[o.mesh(e,n)]:r.error("Invalid TopoJSON object: "+i):void r.error("Missing TopoJSON feature or mesh parameter.")},E={dsv:O,csv:j(","),tsv:j("\t"),json:I,topojson:z},U=function(e,r){return arguments.length>1?(E[e]=r,this):E.hasOwnProperty(e)?E[e]:null},k=function(e,t,n){t=t||{};var o=U(t.type||"json");return o||r.error("Unknown data format type: "+t.type),e=o(e,t),t.parse&&x(e,t.parse,n),e.hasOwnProperty("columns")&&delete e.columns,e};e.loader=T,e.read=k,e.inferType=p,e.inferTypes=m,e.typeParsers=B,e.formats=U,Object.defineProperty(e,"__esModule",{value:!0})});